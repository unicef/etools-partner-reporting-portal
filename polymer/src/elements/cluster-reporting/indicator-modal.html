<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/etools-loading/etools-loading.html">

<link rel="import" href="paper-radio-group-custom.html">
<link rel="import" href="../../polyfills/es6-shim.html">
<link rel="import" href="../../settings.html">
<link rel="import" href="disaggregations-dropdown-widget.html">
<link rel="import" href="indicator-locations-widget.html">
<link rel="import" href="chip-date-of-report.html">
<link rel="import" href="../labelled-item.html">
<link rel="import" href="../etools-prp-chips.html">
<link rel="import" href="../etools-prp-ajax.html">
<link rel="import" href="../etools-prp-date-input.html">
<link rel="import" href="../json-field.html">
<link rel="import" href="../calculation-method.html">
<link rel="import" href="../../endpoints.html">
<link rel="import" href="../../redux/store.html">
<link rel="import" href="../../behaviors/utils.html">
<link rel="import" href="../../behaviors/modal.html">
<link rel="import" href="../../styles/buttons.html">
<link rel="import" href="../../styles/modal.html">
<link rel="import" href="../error-box.html">
<link rel="import" href="../form-fields/cluster-dropdown-content.html">

<dom-module id="indicator-modal">
  <template>
    <style include="button-styles modal-styles app-grid-style iron-flex iron-flex-alignment iron-flex-reverse">
      :host {
        display: block;

        --app-grid-columns: 2;
        --app-grid-gutter: 24px;
        --app-grid-item-height: auto;
        --app-grid-expandible-item-columns: 2;

        --paper-dialog: {
          width: 800px;

          & > * {
            margin: 0;
          }
        };
      }

      .row {
        margin: 16px 0;
      }

      .full-width {
        @apply --app-grid-expandible-item;
        padding-top: 12px;
      }

      .app-grid {
        padding-top: 0;
      }

      .double {
        padding-left: 0;
        justify-content: space-between;
      }

      .title {
        padding-top: 0;
      }

      .pair {
        margin-right: 0;
      }

      .app-grid-triple {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-direction: row;
      }

      .app-grid-triple .item {
        width: 210px;
      }

      .item {
        margin-bottom: 0;
      }

      #mode {
        padding-top: 24px;
      }

      #custom-form-only {
        padding-top: 20px;
      }

      .calculation-method:not(:first-child) {
        margin-left: 50px;
      }

      paper-radio-group {
        margin-left: -12px;
      }

      indicator-locations-widget {
        margin: 2em 0;
      }
    </style>

    <cluster-dropdown-content clusters="{{ clusters }}"></cluster-dropdown-content>

    <etools-prp-ajax
      id="disaggregations"
      url="[[disaggregationsUrl]]"
      params="[[disaggregationsParams]]">
    </etools-prp-ajax>

    <etools-prp-ajax
      id="activities"
      params="[[activitiesParams]]"
      url="[[activitiesUrl]]">
    </etools-prp-ajax>

    <etools-prp-ajax
      id="indicators"
      url="[[indicatorsUrl]]"
      method="post"
      body="[[data]]"
      content-type="application/json">
    </etools-prp-ajax>

    <etools-prp-ajax
      id="objectives"
      timeout="100000"
      url="[[objectivesUrl]]"
      params="[[objectivesParams]]">
    </etools-prp-ajax>

    <etools-prp-ajax
      id="indicatorsList"
      timeout="100000"
      url="[[indicatorsListUrl]]"
      params="[[indicatorsListParams]]">
    </etools-prp-ajax>

    <etools-prp-ajax
      id="indicatorDetail"
      timeout="100000">
    </etools-prp-ajax>

    <paper-dialog
      id="dialog"
      with-backdrop
      on-iron-overlay-closed="_close"
      opened="{{opened}}">

      <div class="header layout horizontal justified">
        <h2>[[modalTitle]]</h2>

        <paper-icon-button
          class="self-center"
          on-tap="_close"
          icon="icons:close">
        </paper-icon-button>
      </div>

      <paper-dialog-scrollable>
        <template
          is="dom-if"
          if="[[opened]]"
          restamp="true">
          <error-box errors="[[errors]]"></error-box>

          <template
            is="dom-if"
            if="[[!_isClusterImo(prpRoles)]]"
            restamp="true">

            <paper-radio-group-custom
              id="mode"
              selected="{{ mode }}"
              on-change="adjustPosition">

              <paper-radio-button name="objectives">
                <strong>Adopt from Cluster Objective</strong>
              </paper-radio-button>

              <div
                class="fields"
                empty$="[[!_equals(mode, 'objectives')]]">
                <template
                  is="dom-if"
                  if="[[_equals(mode, 'objectives')]]"
                  restamp="true">

                  <div class="app-grid">
                    <div class="item">
                      <etools-single-selection-menu
                        id="clustersDropdown"
                        class="validate"
                        label="Clusters *"
                        options="[[clusters]]"
                        option-value="id"
                        option-label="title"
                        selected="{{ selectedCluster }}"
                        on-iron-activate="_validate"
                        disabled="[[_equals(selectedPartner, '')]]"
                        required>
                      </etools-single-selection-menu>
                    </div>

                    <div class="item">
                      <etools-single-selection-menu
                          class="validate"
                          label="Objective *"
                          options="[[objectives]]"
                          option-value="id"
                          option-label="title"
                          selected="{{ selectedObjective }}"
                          on-iron-select="_validate"
                          disabled="[[_equals(objectives.length, 0)]]"
                          required>
                      </etools-single-selection-menu>
                    </div>

                    <div class="item full-width">
                      <etools-single-selection-menu
                        class="validate"
                        label="Indicator *"
                        options="[[indicators]]"
                        option-value="id"
                        option-label="title"
                        selected="{{ selectedIndicator }}"
                        on-iron-select="_validate"
                        disabled="[[_equals(indicators.length, 0)]]"
                        required>
                      </etools-single-selection-menu>
                    </div>

                    <json-field
                      class="item validate"
                      id="target"
                      label="Baseline"
                      value="{{ data.baseline }}"
                      type="[[selectedIndicatorDetailType]]"
                      allowed-pattern="[+\-\d.]"
                      on-input="_validate"
                      required>
                    </json-field>

                    <json-field
                      class="item validate"
                      id="total"
                      label="Target"
                      value="{{ data.target }}"
                      type="[[selectedIndicatorDetailType]]"
                      allowed-pattern="[+\-\d.]"
                      on-input="_validate"
                      required>
                    </json-field>

                    <template
                      is="dom-if"
                      if="[[selectedIndicatorDetailType]]"
                      restamp="true">
                      <div class="item full-width">
                        <indicator-locations-widget
                          class="validate"
                          indicator-type="[[selectedIndicatorDetailType]]"
                          value="{{ data.locations }}">
                        </indicator-locations-widget>
                      </div>
                    </template>

                  </div>
                </template>
              </div>

              <paper-radio-button name="custom">
                <strong>Custom</strong>
              </paper-radio-button>

              <div
                class="fields"
                empty$="[[!_equals(mode, 'custom')]]">
                <template
                  is="dom-if"
                  if="[[_equals(mode, 'custom')]]"
                  restamp="true">

                  <div class="app-grid">
                    <div class="item full-width title">
                      <paper-input
                        class="validate"
                        label="Title"
                        on-input="_validate"
                        value="{{data.blueprint.title}}"
                        always-float-label
                        required>
                      </paper-input>
                    </div>

                    <div class="item full-width">
                      <labelled-item label="Type">
                        <paper-radio-group-custom
                            selected="{{data.blueprint.display_type}}">
                          <paper-radio-button name="number">Quantity (#)</paper-radio-button>
                          <paper-radio-button name="percentage">Percent</paper-radio-button>
                          <paper-radio-button name="ratio">Ratio</paper-radio-button>
                        </paper-radio-group-custom>
                      </labelled-item>
                    </div>

                    <div class="item full-width">
                      <div class="layout horizontal">
                        <labelled-item
                          class="calculation-method"
                          label="Calculation method across locations">
                          <calculation-method
                            value="{{data.blueprint.calculation_formula_across_locations}}"
                            disabled="[[!isNumber]]">
                          </calculation-method>
                        </labelled-item>

                        <labelled-item
                          class="calculation-method"
                          label="Calculation method across reporting periods">
                          <calculation-method
                            value="{{data.blueprint.calculation_formula_across_periods}}"
                            disabled="[[!isNumber]]">
                          </calculation-method>
                        </labelled-item>
                      </div>
                    </div>

                    <div class="item full-width">
                      <paper-input
                        class="validate"
                        label="Comments (optional)"
                        on-input="_validate"
                        value="{{data.comments}}"
                        always-float-label>
                      </paper-input>
                    </div>

                    <div class="item full-width">
                      <paper-input
                        class="validate"
                        label="Measurement specifications (optional)"
                        on-input="_validate"
                        value="{{data.measurement_specifications}}"
                        always-float-label>
                      </paper-input>
                    </div>

                    <div class="item full-width">
                      <div class="app-grid double">
                        <etools-single-selection-menu
                          class="item validate pair"
                          label="Frequency of reporting"
                          options="[[frequencies]]"
                          option-value="id"
                          option-label="title"
                          selected="{{data.frequency}}"
                          on-iron-activate="_validate"
                          trigger-value-change-event
                          hide-search
                          required>
                        </etools-single-selection-menu>

                        <template
                            is="dom-if"
                            if="[[_showCSD(data.frequency)]]"
                            restamp="true">
                          <etools-prp-chips
                            class="item validate"
                            value="{{data.cs_dates}}"
                            label="Due date of report"
                            on-selected-chips-updated="_validate"
                            required>
                            <chip-date-of-report min-date="[[_minDate]]"></chip-date-of-report>
                          </etools-prp-chips>
                        </template>

                        <etools-prp-date-input
                          class="item validate pair"
                          label="Start date of reporting period"
                          value="{{data.start_date_of_reporting_period}}"
                          error-message=""
                          format="[[dateFormat]]"
                          no-init>
                        </etools-prp-date-input>
                      </div>
                    </div>

                    <div class="item full-width">
                      <template
                        is="dom-if"
                        if="[[isNumber]]"
                        restamp="true">
                        <paper-input
                          class="validate"
                          label="Label"
                          on-input="_validate"
                          value="{{data.label}}"
                          always-float-label
                          required>
                        </paper-input>
                      </template>

                      <template
                        is="dom-if"
                        if="[[!isNumber]]"
                        restamp="true">
                        <div class="app-grid double">
                          <paper-input
                            class="item validate pair"
                            label="Numerator Label"
                            on-input="_validate"
                            value="{{data.numerator_label}}"
                            always-float-label
                            required>
                          </paper-input>

                          <paper-input
                            class="item validate pair"
                            label="Denominator Label"
                            on-input="_validate"
                            value="{{data.denominator_label}}"
                            always-float-label
                            required>
                          </paper-input>
                        </div>
                      </template>
                    </div>

                    <div class="item full-width">
                      <template
                        is="dom-if"
                        if="[[isNumber]]"
                        restamp="true">
                        <div class="app-grid-triple">
                          <json-field
                            class="item validate"
                            type="[[data.blueprint.display_type]]"
                            label="Baseline"
                            on-input="_validate"
                            value="{{data.baseline}}"
                            allowed-pattern="[+\-\d]"
                            required>
                          </json-field>

                          <json-field
                            class="item validate"
                            type="[[data.blueprint.display_type]]"
                            label="In need (optional)"
                            on-input="_validate"
                            value="{{data.in_need}}"
                            allowed-pattern="[+\-\d]">
                          </json-field>

                          <json-field
                            class="item validate"
                            type="[[data.blueprint.display_type]]"
                            label="Target"
                            on-input="_validate"
                            value="{{data.target}}"
                            allowed-pattern="[+\-\d]"
                            required>
                          </json-field>
                        </div>
                      </template>
                    </div>

                    <div class="item full-width">
                      <template
                        is="dom-if"
                        if="[[!isNumber]]"
                        restamp="true">
                        <div class="app-grid double">
                          <json-field
                            class="item validate pair"
                            type="[[data.blueprint.display_type]]"
                            label="Baseline"
                            on-input="_validate"
                            value="{{data.baseline}}"
                            allowed-pattern="[+\-\d]"
                            required>
                          </json-field>

                          <json-field
                            class="item validate pair"
                            type="[[data.blueprint.display_type]]"
                            label="Target"
                            on-input="_validate"
                            value="{{data.target}}"
                            allowed-pattern="[+\-\d]"
                            required>
                          </json-field>
                        </div>
                      </template>
                    </div>

                    <div class="item full-width">
                      <indicator-locations-widget
                        class="validate"
                        indicator-type="[[data.blueprint.display_type]]"
                        is-pai="[[_isPAI(activityData)]]"
                        editing="[[false]]"
                        value="{{data.locations}}">
                      </indicator-locations-widget>
                    </div>

                    <div class="item full-width">
                      <disaggregations-dropdown-widget
                        class="validate"
                        value="{{selectedDisaggregations}}"
                        disaggregations="[[disaggregations]]">
                      </disaggregations-dropdown-widget>
                    </div>
                  </div>

                </template>
              </div>
            </paper-radio-group-custom>
          </template>

          <template
            is="dom-if"
            if="[[_isClusterImo(prpRoles)]]"
            restamp="true">

            <div class="app-grid" id="custom-form-only">
              <div class="item full-width title">
                <paper-input
                  class="validate"
                  label="Title"
                  on-input="_validate"
                  value="{{data.blueprint.title}}"
                  always-float-label
                  required>
                </paper-input>
              </div>

              <div class="item full-width">
                <labelled-item label="Type">
                  <paper-radio-group-custom
                      selected="{{data.blueprint.display_type}}">
                    <paper-radio-button name="number">Quantity (#)</paper-radio-button>
                    <paper-radio-button name="percentage">Percent</paper-radio-button>
                    <paper-radio-button name="ratio">Ratio</paper-radio-button>
                  </paper-radio-group-custom>
                </labelled-item>
              </div>

              <div class="item full-width">
                <div class="layout horizontal">
                  <labelled-item
                    class="calculation-method"
                    label="Calculation method across locations">
                    <calculation-method
                      value="{{data.blueprint.calculation_formula_across_locations}}"
                      disabled="[[!isNumber]]">
                    </calculation-method>
                  </labelled-item>

                  <labelled-item
                    class="calculation-method"
                    label="Calculation method across reporting periods">
                    <calculation-method
                      value="{{data.blueprint.calculation_formula_across_periods}}"
                      disabled="[[!isNumber]]">
                    </calculation-method>
                  </labelled-item>
                </div>
              </div>

              <div class="item full-width">
                <paper-input
                  class="validate"
                  label="Comments (optional)"
                  on-input="_validate"
                  value="{{data.comments}}"
                  always-float-label>
                </paper-input>
              </div>

              <div class="item full-width">
                <paper-input
                  class="validate"
                  label="Measurement specifications (optional)"
                  on-input="_validate"
                  value="{{data.measurement_specifications}}"
                  always-float-label>
                </paper-input>
              </div>

              <template
              is="dom-if"
              if="[[_equals(modalTitle, 'Add Activity Indicator')]]"
              restamp="true">
                <div class="item full-width">
                  <etools-single-selection-menu
                    class="item validate pair"
                    label="Project context"
                    options="[[activityData.projects]]"
                    option-value="context_id"
                    option-label="project_name"
                    selected="{{data.project_context_id}}"
                    on-iron-activate="_validate"
                    trigger-value-change-event
                    hide-search
                    required>
                  </etools-single-selection-menu>
                </div>
              </template>

              <div class="item full-width">
                <div class="app-grid double">
                  <etools-single-selection-menu
                    class="item validate pair"
                    label="Frequency of reporting"
                    options="[[frequencies]]"
                    option-value="id"
                    option-label="title"
                    selected="{{data.frequency}}"
                    on-iron-activate="_validate"
                    trigger-value-change-event
                    hide-search
                    required>
                  </etools-single-selection-menu>

                  <template
                      is="dom-if"
                      if="[[_showCSD(data.frequency)]]"
                      restamp="true">
                    <etools-prp-chips
                      class="item validate"
                      value="{{data.cs_dates}}"
                      label="Due date of report"
                      on-selected-chips-updated="_validate"
                      required>
                      <chip-date-of-report min-date="[[_minDate]]"></chip-date-of-report>
                    </etools-prp-chips>
                  </template>

                  <etools-prp-date-input
                    class="item validate pair"
                    label="Start date of reporting period"
                    value="{{data.start_date_of_reporting_period}}"
                    error-message=""
                    format="[[dateFormat]]"
                    no-init>
                  </etools-prp-date-input>
                </div>
              </div>

              <div class="item full-width">
                <template
                  is="dom-if"
                  if="[[isNumber]]"
                  restamp="true">
                  <paper-input
                    class="validate"
                    label="Label"
                    on-input="_validate"
                    value="{{data.label}}"
                    always-float-label
                    required>
                  </paper-input>
                </template>

                <template
                  is="dom-if"
                  if="[[!isNumber]]"
                  restamp="true">
                  <div class="app-grid double">
                    <paper-input
                      class="item validate pair"
                      label="Numerator Label"
                      on-input="_validate"
                      value="{{data.numerator_label}}"
                      always-float-label
                      required>
                    </paper-input>

                    <paper-input
                      class="item validate pair"
                      label="Denominator Label"
                      on-input="_validate"
                      value="{{data.denominator_label}}"
                      always-float-label
                      required>
                    </paper-input>
                  </div>
                </template>
              </div>

              <div class="item full-width">
                <template
                  is="dom-if"
                  if="[[isNumber]]"
                  restamp="true">
                  <div class="app-grid-triple">
                    <json-field
                      class="item validate"
                      type="[[data.blueprint.display_type]]"
                      label="Baseline"
                      on-input="_validate"
                      value="{{data.baseline}}"
                      allowed-pattern="[+\-\d]"
                      required>
                    </json-field>

                    <json-field
                      class="item validate"
                      type="[[data.blueprint.display_type]]"
                      label="In need (optional)"
                      on-input="_validate"
                      value="{{data.in_need}}"
                      allowed-pattern="[+\-\d]">
                    </json-field>

                    <json-field
                      class="item validate"
                      type="[[data.blueprint.display_type]]"
                      label="Target"
                      on-input="_validate"
                      value="{{data.target}}"
                      allowed-pattern="[+\-\d]"
                      required>
                    </json-field>
                  </div>
                </template>
              </div>

              <div class="item full-width">
                <template
                  is="dom-if"
                  if="[[!isNumber]]"
                  restamp="true">
                  <div class="app-grid double">
                    <json-field
                      class="item validate pair"
                      type="[[data.blueprint.display_type]]"
                      label="Baseline"
                      on-input="_validate"
                      value="{{data.baseline}}"
                      allowed-pattern="[+\-\d]"
                      required>
                    </json-field>

                    <json-field
                      class="item validate pair"
                      type="[[data.blueprint.display_type]]"
                      label="Target"
                      on-input="_validate"
                      value="{{data.target}}"
                      allowed-pattern="[+\-\d]"
                      required>
                    </json-field>
                  </div>
                </template>
              </div>

              <div class="item full-width">
                <indicator-locations-widget
                  class="validate"
                  indicator-type="[[data.blueprint.display_type]]"
                  is-pai="[[_isPAI(activityData)]]"
                  editing="[[false]]"
                  value="{{data.locations}}">
                </indicator-locations-widget>
              </div>

              <div class="item full-width">
                <disaggregations-dropdown-widget
                  class="validate"
                  value="{{selectedDisaggregations}}"
                  disaggregations="[[disaggregations]]">
                </disaggregations-dropdown-widget>
              </div>
            </div>
          </template>

        </template>
      </paper-dialog-scrollable>

      <div class="buttons layout horizontal-reverse">
        <paper-button
            on-tap="_save"
            class="btn-primary"
            raised>
          Save
        </paper-button>

        <paper-button
            on-tap="_close">
          Cancel
        </paper-button>
      </div>

      <etools-loading active="[[updatePending]]"></etools-loading>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'indicator-modal',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
        App.Behaviors.ModalBehavior,
      ],

      properties: {
        data: Object,
        objectId: Number,
        activityData: Object,
        projectData: Object,
        objectType: String,
        modalTitle: String,

        isNumber: {
          type: Boolean,
          computed: '_computeIsNumber(data.blueprint.display_type)',
        },

        mode: {
          type: String,
          observer: '_setDefaults',
        },

        responsePlanId: {
          type: String,
          statePath: 'responsePlans.currentID',
        },

        disaggregationsUrl: {
          type: String,
          computed: '_computeDisaggregationsUrl(responsePlanId)',
        },

        indicatorsUrl: {
          type: String,
          value: '',
        },

        indicatorsListUrl: {
          type: String,
          value: App.Endpoints.indicators('co') + '/',
        },

        indicatorsListParams: {
          type: Object,
          value: {},
        },

        activitiesUrl: String,

        activitiesParams: {
          type: Object,
          value: {
            page_size: 99999,
          },
        },

        activities: {
          type: Array,
          value: [],
        },

        selectedActivity: {
          type: String,
          value: '',
        },

        clusters: {
          format: Array,
          value: [],
        },

        selectedCluster: {
          type: String,
          value: '',
        },

        objectives: {
          type: Array,
          value: [],
        },

        selectedObjective: {
          type: String,
          value: '',
        },

        objectivesParams: {
          type: Object,
          value: {}
        },

        indicators: {
          type: Array,
          value: [],
        },

        selectedIndicator: {
          type: String,
          value: '',
        },

        selectedIndicatorDetailType: String,

        objectivesUrl: {
          type: String,
          computed: '_computeObjectivesUrl(responsePlanId)',
        },

        partnerID: {
          type: String,
          statePath: 'partner.current.id',
        },

        prpRoles: {
          type: Array,
          statePath: 'userProfile.profile.prp_roles',
        },

        updatePending: {
          type: Boolean,
          value: false,
        },

        disaggregationsParams: {
          type: Object,
          value: {
            page_size: 99999,
          },
        },

        selectedDisaggregations: {
          type: Array,
          value: [],
          notify: true,
        },

        frequencies: {
          type: Array,
          value: [
            {
              id: 'Wee',
              title: 'Weekly',
            },
            {
              id: 'Mon',
              title: 'Monthly',
            },
            {
              id: 'Qua',
              title: 'Quarterly',
            },
            {
              id: 'Csd',
              title: 'Custom specific dates',
            },
          ],
        },

        disaggregations: {
          type: Array,
          value: [],
        },

        dateFormat: {
          type: String,
          value: function () {
            return App.Settings.dateFormat;
          },
        },

        _minDate: {
          type: Date,
          value: function () {
            return null;
          },
          computed: '_computeMinDate(data.start_date_of_reporting_period)',
        },
      },

      observers: [
        '_setDefaults(opened)',
        '_isClusterImo(prpRoles)',
        '_resetCalculationFormulas(isNumber)',
        '_resetFields(isNumber)',
        '_updateCSDates(data.start_date_of_reporting_period)',
        '_saveCluster(selectedCluster)',
        '_fetchActivities(selectedCluster)',
        '_fetchObjectivesList(selectedCluster)',
        '_fetchIndicatorsList(selectedObjective)',
        '_fetchActivityIndicatorsList(selectedActivity)',
        '_fetchSelectedIndicatorDetailType(responsePlanId, selectedIndicator)',
      ],

      adjustPosition: function (e) {
        e.stopPropagation();

        this.debounce('adjust-position', function () {
          this.$.dialog.refit();
        }, 100);
      },

      _isClusterImo: function (prpRoles) {
        var isImo = prpRoles.find(function (role) {
          return role.role === 'CLUSTER_IMO';
        });

        if (isImo !== undefined && this.modalTitle === 'Add Cluster Objective Indicator'
          || isImo !== undefined && this.modalTitle === 'Add Activity Indicator'
          || isImo !== undefined && this.modalTitle === 'Add Cluster Activity Indicator'
        ) {
          this.set('mode', 'custom');
          return true;
        } else if (isImo !== undefined && this.modalTitle === 'Add Project Indicator') {
          this.set('imoInPartner', true);
          return false;
        } else {
          return false;
        }
      },

      _computeIsNumber: function (type) {
        return type === 'number';
      },

      _resetCalculationFormulas: function (isNumber) {
        if (isNumber) {
          return;
        }

        var formula = 'sum';

        this.set('data.blueprint.calculation_formula_across_locations', formula);
        this.set('data.blueprint.calculation_formula_across_periods', formula);
      },

      _resetFields: function (isNumber) {
        var data = this.get('data');
        var newData;

        if (isNumber) {
          newData = this._omit(data, ['numerator_label', 'denominator_label']);
        } else {
          newData = this._omit(data, ['label', 'in_need']);
        }

        this.set('data', newData);
      },

      _setFrequency: function (e, data) {
        var freq = this.$$('#frequencies').itemForElement(data.value);
        if (!freq) {
          return;
        }
        this.set('data.frequency', freq.id);
      },

      _isPAI: function (activityData) {
        return Object.keys(activityData).length !== 0;
      },

      _setDisaggregations: function () {
        var selected = this.selectedDisaggregations ?
        this.selectedDisaggregations.map(function(dis) {
          return {
            id: dis.id,
          };
        }) : [];
        this.set('data.disaggregations', selected);
      },

      _disableOtherRadioButton: function() {
        var self = this;
        var radioGroup = this.$$('#mode');

        if (radioGroup !== undefined) {
          var otherRadio = Polymer.dom(radioGroup).children.find(function (element) {
            return element.nodeName === 'PAPER-RADIO-BUTTON' && element.name !== self.mode;
          });

          if (otherRadio !== undefined) {
            otherRadio.disabled = true;
          }
        }
      },

      _setDefaults: function (opened) {
        if (!opened) {
          return;
        }

        if (this.mode === undefined) {
          return;
        }

        if (this.mode === 'objectives') {
          this.set('data', {
            partner_id: this.projectData.partner_id || this.partnerID,
            partner_project_id: '',
            cluster_id: '',
            cluster_objective_id: '',
            reportable_id: '',
            locations: [],
            target: {d: 1},
            baseline: {d: 1}
          });

          this._disableOtherRadioButton();

          this.set('indicatorsUrl', App.Endpoints.adoptedClusterIndicators());
        } else {
          this.set('selectedDisaggregations', []);
          this.set('errors', {});
          this.set('data', {
            blueprint: {
              display_type: 'number',
              calculation_formula_across_locations: 'sum',
              calculation_formula_across_periods: 'sum',
            },
            cs_dates: [],
            locations: [],
            disaggregations: [],
          });

          if (this.mode === 'activity') {
            this.set('indicatorsListUrl', App.Endpoints.indicators('ca') + '/');
          }

          this.set('indicatorsUrl', App.Endpoints.clusterIndicators());

          this._fetchDisaggregations();
          this._disableOtherRadioButton();
        }
      },

      _validate: function (e) {
        e.target.validate();
      },

      _showCSD: function (frequency) {
        return frequency && this._equals(frequency, 'Csd');
      },

      _computeDisaggregationsUrl: function(responsePlanId) {
        return App.Endpoints.responseParametersClusterDisaggregations(responsePlanId);
      },

      _computeMinDate: function (date) {
        return date ? this._normalizeDate(date) : null;
      },

      _computeObjectivesUrl: function (responsePlanId) {
        return App.Endpoints.responseParametersClusterObjectives(responsePlanId);
      },

      _fetchDisaggregations: function() {
        var self = this;

        this.$.disaggregations.thunk()()
          .then(function(res) {
            self.set('disaggregations', res.data.results);
          });
      },

      _savePartner: function (selectedPartnerId) {
        this.set('data.partner_id', selectedPartnerId);
      },

      _saveCluster: function () {
        if (this.mode === 'objectives') {
          this.set('data.cluster_id', this.selectedCluster);
        }
      },

      _fetchActivities: function (clusterId) {
        var self = this;
        if (typeof clusterId === 'undefined' || typeof this.responsePlanId === 'undefined') {
          return;
        }
        this.set('activities', []);
        this.set('activitiesParams.cluster_id', clusterId);
        this.set('activitiesUrl',
            App.Endpoints.responseParametersClusterActivities(this.responsePlanId)
            + '?cluster_id=' + clusterId);
        this.$.activities.abort();

        this.$.activities.thunk()()
            .then(function (res) {
              self.set('activities', res.data.results);
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
      },

      _fetchActivityIndicatorsList: function (selectedId) {
        if (selectedId === '') {
          return;
        }

        this.set('indicatorsListParams', {object_id: selectedId, page_size: 9999, page: 1});

        this.debounce('fetch-indicators', function () {
          var self = this;

          this.set('indicators', []);

          this.$.indicatorsList.abort();
          this.$.indicatorsList.thunk()()
            .then(function (res) {
              var simpleIndicatorsList = [];

              res.data.results.forEach(function (indicator) {
                var simpleIndicator = indicator;
                simpleIndicator.title = indicator.blueprint.title;

                simpleIndicatorsList.push(simpleIndicator);
              });

              self.set('indicators', simpleIndicatorsList);
              self.fire('details-loaded');
            });
        });
      },

      _fetchObjectivesList: function (selectedClusterId) {
        if (selectedClusterId === '') {
          return;
        }

        if (this.mode === 'objectives') {
          this.set('data.cluster_id', selectedClusterId);
          this.set('data.partner_project_id', parseInt(this.objectId));
        }

        this.debounce('fetch-objectives', function () {
          var self = this;

          this.set('objectives', []);
          this.set('objectivesParams.cluster_id', selectedClusterId);

          this.$.objectives.abort();
          this.$.objectives.thunk()()
            .then(function (res) {
              self.set('objectives', res.data.results);
              self.fire('details-loaded');
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
        }, 100);
      },

      _fetchIndicatorsList: function (selectedObjectiveId) {
        if (selectedObjectiveId === '') {
          return;
        }
        this.set('data.cluster_objective_id', selectedObjectiveId);
        this.set('indicatorsListParams', {object_id: selectedObjectiveId});

        this.debounce('fetch-indicators', function () {
          var self = this;

          this.set('indicators', []);

          this.$.indicatorsList.abort();
          this.$.indicatorsList.thunk()()
            .then(function (res) {
              var simpleIndicatorsList = [];

              res.data.results.forEach(function (indicator) {
                var simpleIndicator = {};
                simpleIndicator.id = indicator.id;
                simpleIndicator.title = indicator.blueprint.title;

                simpleIndicatorsList.push(simpleIndicator);
              });

              self.set('indicators', simpleIndicatorsList);
              self.fire('details-loaded');
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
        }, 100);
      },

      _fetchSelectedIndicatorDetailType: function (responsePlanId, selectedIndicator) {
        if (selectedIndicator === undefined || selectedIndicator === '') {
          return;
        }

        this.debounce('fetch-selected-indicator', function () {
          var self = this;

          if (this.mode === 'objectives') {
            this.set('data.reportable_id', selectedIndicator);
          }

          if (this.mode === 'activity') {
            var chosenActivityIndicator = this.indicators.find(function (indicator) {
              return indicator.id === selectedIndicator;
            });

            this.set('data.blueprint.title', chosenActivityIndicator.title);
            this.set('data.frequency', chosenActivityIndicator.frequency);
            this.set('data.label', chosenActivityIndicator.label);
            this.set('data.start_date_of_reporting_period', chosenActivityIndicator.start_date_of_reporting_period);
          }

          this.$.indicatorDetail.url = App.Endpoints.analysisIndicator(responsePlanId, selectedIndicator);

          this.$.indicatorDetail.abort();
          this.$.indicatorDetail.thunk()()
            .then(function (res) {
              self.set('selectedIndicatorDetailType', res.data.display_type);
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
        }, 100);
      },

      _processData: function (rawData) {
        var data = this._clone(rawData);
        var invalidLocations = [];

        if (data.frequency !== 'Csd') {
          delete data.cs_dates;
        }

        data.baseline.v = parseInt(data.baseline.v);
        data.target.v = parseInt(data.target.v);

        if (data.in_need !== undefined) {
          data.in_need.v = parseInt(data.in_need.v);
        }

        if (data.blueprint === undefined) {
          data.baseline.d = 1;
          data.target.d = 1;

          if (data.in_need !== undefined) {
            data.in_need.d = 1;
          }

          data.locations.forEach(function(location, idx, arr) {
            location.baseline.d = 1;
            location.target.d = 1;
            location.baseline.v = parseInt(location.baseline.v);
            location.target.v = parseInt(location.target.v);

            if (data.in_need !== undefined) {
              if (location.in_need !== undefined) {
                location.in_need.d = 1;
                location.in_need.v = parseInt(location.in_need.v);

                if (location.in_need.v > data.in_need.v) {
                  invalidLocations.push(
                    'Location ' + location.title + ' has a greater in need than its indicator-level in need'
                  );
                }
              } else {
                invalidLocations.push(
                  'Location ' + location.title + ' does not have in need while indicator level in need exists'
                );
              }
            } else {
              delete location.in_need;
            }

            if (location.baseline.v > data.baseline.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater baseline than its indicator-level baseline'
              );
            }
            if (location.target.v > data.target.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater target than its indicator-level target'
              );
            }

            if (location.in_need !== undefined && location.target.v > location.in_need.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a target greater than its in need'
              );
            }

            arr[idx] = location;
          });
        } else if (data.blueprint.display_type === 'percentage') {
          data.baseline.d = 100;
          data.target.d = 100;

          if (data.in_need !== undefined) {
            data.in_need.d = 100;
          }

          data.locations.forEach(function(location, idx, arr) {
            location.baseline.d = 100;
            location.target.d = 100;
            location.baseline.v = parseInt(location.baseline.v);
            location.target.v = parseInt(location.target.v);

            if (data.in_need !== undefined) {
              if (location.in_need !== undefined) {
                location.in_need.d = 100;
                location.in_need.v = parseInt(location.in_need.v);

                if (location.in_need.v > data.in_need.v) {
                  invalidLocations.push(
                    'Location ' + location.title + ' has a greater in need than its indicator-level in need'
                  );
                }
              } else {
                invalidLocations.push(
                  'Location ' + location.title + ' does not have in need while indicator level in need exists'
                );
              }
            } else {
              delete location.in_need;
            }

            if (location.baseline.v > data.baseline.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater baseline than its indicator-level baseline'
              );
            }
            if (location.target.v > data.target.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater target than its indicator-level target'
              );
            }

            if (location.in_need !== undefined && location.target.v > location.in_need.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a target greater than its in need'
              );
            }

            arr[idx] = location;
          });
        } else if (data.blueprint.display_type === 'number') {
          data.baseline.d = 1;
          data.target.d = 1;

          if (data.in_need !== undefined) {
            data.in_need.d = 1;
          }

          data.locations.forEach(function(location, idx, arr) {
            location.baseline.d = 1;
            location.target.d = 1;
            location.baseline.v = parseInt(location.baseline.v);
            location.target.v = parseInt(location.target.v);

            if (data.in_need !== undefined) {
              if (location.in_need !== undefined) {
                location.in_need.d = 1;
                location.in_need.v = parseInt(location.in_need.v);

                if (location.in_need.v > data.in_need.v) {
                  invalidLocations.push(
                    'Location ' + location.title + ' has a greater in need than its indicator-level in need'
                  );
                }
              } else {
                invalidLocations.push(
                  'Location ' + location.title + ' does not have in need while indicator level in need exists'
                );
              }
            } else {
              delete location.in_need;
            }

            if (location.baseline.v > data.baseline.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater baseline than its indicator-level baseline'
              );
            }
            if (location.target.v > data.target.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater target than its indicator-level target'
              );
            }

            if (location.in_need !== undefined && location.target.v > location.in_need.v) {
              invalidLocations.push(
                'Location ' + location.title + ' has a target greater than its in need'
              );
            }

            arr[idx] = location;
          });
        } else if (data.blueprint.display_type === 'ratio') {
          data.baseline.d = parseInt(data.baseline.d);
          data.target.d = parseInt(data.target.d);

          if (data.in_need !== undefined) {
            data.in_need.d = parseInt(data.in_need.d);
            data.in_need.c = data.in_need.v / data.in_need.d;
          }

          data.baseline.c = data.baseline.v / data.baseline.d;
          data.target.c = data.target.v / data.target.d;

          data.locations.forEach(function(location, idx, arr) {
            location.baseline.v = parseInt(location.baseline.v);
            location.target.v = parseInt(location.target.v);

            location.baseline.d = parseInt(location.baseline.d);
            location.target.d = parseInt(location.target.d);

            location.baseline.c = location.baseline.v / location.baseline.d;
            location.target.c = location.target.v / location.target.d;

            if (data.in_need !== undefined) {
              if (location.in_need !== undefined) {
                location.in_need.d = parseInt(location.in_need.d);
                location.in_need.v = parseInt(location.in_need.v);
                location.in_need.c = location.in_need.v / location.in_need.d;

                if (location.in_need.c > data.in_need.c) {
                  invalidLocations.push(
                    'Location ' + location.title + ' has a greater in need than its indicator-level in need'
                  );
                }
              } else {
                invalidLocations.push(
                  'Location ' + location.title + ' does not have in need while indicator level in need exists'
                );
              }
            } else {
              delete location.in_need;
            }

            if (location.baseline.c > data.baseline.c) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater baseline than its indicator-level baseline'
              );
            }
            if (location.target.c > data.target.c) {
              invalidLocations.push(
                'Location ' + location.title + ' has a greater target than its indicator-level target'
              );
            }

            if (location.in_need !== undefined && location.target.c > location.in_need.c) {
              invalidLocations.push(
                'Location ' + location.title + ' has a target greater than its in need'
              );
            }

            arr[idx] = location;
          });
        }

        if (invalidLocations.length !== 0) {
          return invalidLocations;
        }

        return Object.assign(data, {
          object_id: this.objectId,
          object_type: this.objectType,
        });
      },

      _updateCSDates: function (startDateStr) {
        var dates;
        var startDate;

        if (!startDateStr) {
          return;
        }

        dates = this.get('data.cs_dates');
        startDate = this._normalizeDate(startDateStr);

        this.set('data.cs_dates', dates && dates.filter(function (d) {
          return this._normalizeDate(d) >= startDate;
        }, this));
      },

      _save: function () {
        var self = this;
        var dataCopy = this._clone(this.data);

        var noLocationSet = false;
        var rawLocations = this.get('data.locations');

        var changedLocations = rawLocations.map(function (location) {
          if (location.location !== undefined && location.location.id !== undefined) {
            var id = location.location.id;
            var title = location.location.title;
            location.location = id;
            location.title = title;
            return location;
          } else if (location.loc_type !== undefined && location.location === undefined) {
            self.set('errors', 'No location set - please set a location.');
            noLocationSet = true;
            return location;
          } else {
            return location;
          }
        });

        if (noLocationSet === true) {
          return;
        }

        if (!this._fieldsAreValid()) {
          return;
        }

        this.set('data.locations', changedLocations);
        this._setDisaggregations();

        var data = this._processData(this.get('data'));

        if (data instanceof Array) {
          this.set('errors', {locations: data});
          return;
        }

        this.set('data', data);

        this.$.indicators.body = data;

        this.set('updatePending', true);
        this.$.indicators.thunk()()
          .then(function (res) {
            self.fire('indicator-added', res.data);
            self.set('updatePending', false);
            self.set('errors', {});
            self.set('data', {});
            self.set('clusters', []);
            self.set('selectedCluster', '');
            self.set('objectives', []);
            self.set('selectedObjective', '');
            self.set('activities', []);
            self.set('selectedActivity', '');
            self.set('indicators', []);
            self.set('selectedIndicator', '');
            self.set('selectedIndicatorDetailType', undefined);

            if (this.modalTitle === 'Add Project Indicator') {
              self.set('mode', '');
            }
            self.close();
          })
          .catch(function (err) {
            self.set('errors', err.data);
            self.set('data.locations', dataCopy.locations);
            self.set('updatePending', false);
          }).finally();
      },

      _close: function (e) {
        if (e.target.nodeName === 'PAPER-DIALOG' ||
            e.target.nodeName === 'PAPER-BUTTON' ||
            e.target.nodeName === 'PAPER-ICON-BUTTON') {

          if (this.modalTitle === 'Add Project Indicator') {
            this.set('mode', '');
          }

          this.set('data', {});

          this.set('clusters', []);
          this.set('selectedCluster', '');

          this.set('objectives', []);
          this.set('selectedObjective', '');

          this.set('activities', []);
          this.set('selectedActivity', '');

          this.set('indicators', []);
          this.set('selectedIndicator', '');
          this.set('selectedIndicatorDetailType', undefined);

          this.close();
        } else {
          return;
        }
      },
    });
  </script>
</dom-module>
