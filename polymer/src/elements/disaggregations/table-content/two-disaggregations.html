<link rel="import" href="../../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../../bower_components/etools-data-table/etools-data-table.html">

<link rel="import" href="../../../behaviors/disaggregations.html">
<link rel="import" href="../../../behaviors/utils.html">
<link rel="import" href="../../../styles/detail-table.html">
<link rel="import" href="../disaggregation-table-row.html">

<dom-module id="two-disaggregations">
  <template>

    <style include='detail-table'></style>

    <tr class='horizontal layout'>
      <th class='flex cell border'></th>
      <template is="dom-repeat"
                items="[[columns]]"
                as="column">
        <th class='flex cell border'>[[_capitalizeFirstLetter(column.value)]]</th>
      </template>
      <th class='flex cell border'>Total</th>
    </tr>

    <template is="dom-repeat"
              items="[[rowsForDisplay]]"
              as="row">
      <disaggregation-table-row data=[[row]]></disaggregation-table-row>
   </template>

   <disaggregation-table-row
    data=[[totalsForDisplay]]
    total=[[total]]
    type="headerRow">
  </disaggregation-table-row>

  </template>

  <script>
    Polymer({
      is: 'two-disaggregations',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.DisaggregationBehavior,
      ],

      properties: {
        data: {
          type: Object,
          value: {}
        },

        mapping: {
          type: Array,
          value: []
        },

        total: Number,

        editable: Boolean,

        //Passing columnNames as a param is required to trigger update.
        columns: {
          type: Array,
          computed: '_getColumns(mapping)'
        },

        totalsForDisplay: {
          type: Array,
          computed: '_determineTotals(mapping)'
        },

        rowsForDisplay: {
          type: Array,
          computed: '_determineRows(mapping)'
        },
      },

      _getColumns: function(mapping) {
        return this.mapping[0].choices;
      },

      _determineRows: function() {
        var self = this;
        var columnChoices = this.mapping[0].choices;
        var rows = this.mapping[1].choices;
        var rowsForDisplay = [];
        var lookup = self.data.disaggregation;

        rows.map(function(x) {
          var title = x.value;
          var rowData = columnChoices.map(function(z) {
            var formatted = self._formatDisaggregationIds([x.id, z.id]);
            var valueObject = lookup[formatted];
            return valueObject;
          });
          var formatted = self._formatDisaggregationIds([x.id]);
          var rowTotal = self.data.disaggregation[formatted];

          rowsForDisplay.push({
            title: x.value,
            data: rowData,
            id: x.id,
            total: rowTotal
          });
        });
        return rowsForDisplay;
      },

      _determineTotals: function() {
        var self = this;
        var columnChoices = this.mapping[0].choices;

        var columnData = columnChoices.map(function(z) {
          var formatted = self._formatDisaggregationIds([z.id]);
          var data = self.data.disaggregation[formatted];
          return data
        });

        var columnTotalRow = {
          data: columnData,
          title: 'total',
          total: this.total
        };

        return columnTotalRow;
      },

    });
  </script>
</dom-module>
