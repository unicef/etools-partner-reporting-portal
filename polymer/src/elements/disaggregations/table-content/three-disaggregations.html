<link rel="import" href="../../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../behaviors/disaggregations.html">
<link rel="import" href="../../../behaviors/utils.html">
<link rel="import" href="../../../styles/disaggregation-table-styles.html">
<link rel="import" href="../disaggregation-table-row.html">

<dom-module id="three-disaggregations">
  <template>
    <style include="disaggregation-table-styles"></style>

    <div class="app-grid">
      <div class="item">
        <table>
          <template
              is="dom-if"
              if="[[_hasDisaggregationData(data.disaggregation, 0)]]">
            <!-- Column names -->
            <tr class="horizontal layout headerRow">
              <th></th>
              <template
                  is="dom-repeat"
                  items="[[columns]]"
                  as="column">
                <th>[[_capitalizeFirstLetter(column.value)]]</th>
              </template>
              <th>Total</th>
            </tr>

            <!-- Data rows: outer and middle. -->
            <template is="dom-repeat"
                items="[[_determineOuterRows(columns, rows, data.disaggregation.0)]]"
                as="outerRow">
              <disaggregation-table-row
                  data="[[outerRow]]"
                  indicator-type="[[data.display_type]]"
                  row-type="outerRow"
                  disagg-index="0">
              </disaggregation-table-row>

              <template
                  is="dom-repeat"
                  items="[[_determineMiddleRows(outerRow.id, columns, middleRows, data.disaggregation.0)]]"
                  as="middleRow">
                <disaggregation-table-row
                    data="[[middleRow]]"
                    level-reported="[[data.level_reported]]"
                    indicator-type="[[data.display_type]]"
                    row-type="middleRow"
                    editable="[[editable]]"
                    disagg-index="0">
                </disaggregation-table-row>
              </template>
            </template>

            <!-- Totals row -->
            <disaggregation-table-row
                data="[[_determineColumnTotalRow(columns, middleRows, data.disaggregation.0)]]"
                level-reported="[[data.level_reported]]"
                indicator-type="[[data.display_type]]"
                row-type="totalsRow"
                disagg-index="0">
            </disaggregation-table-row>

            <!-- Bottom table -->
            <template
                is="dom-repeat"
                items="[[_determineBottomRows(middleRows, columns, data.disaggregation.0)]]"
                as="bottomRow">
              <disaggregation-table-row
                  data="[[bottomRow]]"
                  level-reported="[[data.level_reported]]"
                  indicator-type="[[data.display_type]]"
                  row-type="bottomRow"
                  disagg-index="0">
              </disaggregation-table-row>
            </template>
          </template>
        </table>
      </div>

      <div class="item">
        <table>
          <template
              is="dom-if"
              if="[[_hasDisaggregationData(data.disaggregation, 1)]]">
            <!-- Column names -->
            <tr class="horizontal layout headerRow">
              <th></th>
              <template
                  is="dom-repeat"
                  items="[[columns]]"
                  as="column">
                <th>[[_capitalizeFirstLetter(column.value)]]</th>
              </template>
              <th>Total</th>
            </tr>

            <!-- Data rows: outer and middle. -->
            <template is="dom-repeat"
                items="[[_determineOuterRows(columns, rows, data.disaggregation.1)]]"
                as="outerRow">
              <disaggregation-table-row
                  data="[[outerRow]]"
                  indicator-type="[[data.display_type]]"
                  row-type="outerRow"
                  disagg-index="1">
              </disaggregation-table-row>

              <template
                  is="dom-repeat"
                  items="[[_determineMiddleRows(outerRow.id, columns, middleRows, data.disaggregation.1)]]"
                  as="middleRow">
                <disaggregation-table-row
                    data="[[middleRow]]"
                    level-reported="[[data.level_reported]]"
                    indicator-type="[[data.display_type]]"
                    row-type="middleRow"
                    editable="[[editable]]"
                    disagg-index="1">
                </disaggregation-table-row>
              </template>
            </template>

            <!-- Totals row -->
            <disaggregation-table-row
                data="[[_determineColumnTotalRow(columns, middleRows, data.disaggregation.1)]]"
                level-reported="[[data.level_reported]]"
                indicator-type="[[data.display_type]]"
                row-type="totalsRow"
                disagg-index="1">
            </disaggregation-table-row>

            <!-- Bottom table -->
            <template
                is="dom-repeat"
                items="[[_determineBottomRows(middleRows, columns, data.disaggregation.1)]]"
                as="bottomRow">
              <disaggregation-table-row
                  data="[[bottomRow]]"
                  level-reported="[[data.level_reported]]"
                  indicator-type="[[data.display_type]]"
                  row-type="bottomRow"
                  disagg-index="1">
              </disaggregation-table-row>
            </template>
          </template>
        </table>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'three-disaggregations',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.DisaggregationBehavior,
      ],

      properties: {
        editable: Number,

        data: Object,

        mapping: Array,

        columnTotalRow: Object,

        columns: {
          type: Array,
          computed: '_getColumns(mapping)'
        },

        rows: {
          type: Array,
          computed: '_getRows(mapping)',
        },

        middleRows: {
          type: Array,
          computed: '_getMiddleRows(mapping)',
        },
      },

      _getColumns: function (mapping) {
        return (mapping[0] || []).choices;
      },

      _getRows: function (mapping) {
        return (mapping[1] || []).choices;
      },

      _getMiddleRows: function (mapping) {
        return (mapping[2] || []).choices;
      },

      _determineOuterRows: function (columns, rows, data) {
        return this._determineRows(rows, columns, data);
      },

      _determineMiddleRows: function (outerRowID, columns, middleRows, data) {
        if (!columns || !middleRows) {
          return [];
        }

        return middleRows.map(function (y) {
          var formatted;

          var columnData = columns.map(function (z) {
            formatted = this._formatDisaggregationIds([outerRowID, y.id, z.id]);

            return {
              key: formatted,
              data: data[formatted],
            };
          }, this);

          formatted = this._formatDisaggregationIds([outerRowID, y.id]);

          return {
            title: y.value,
            data: columnData,
            id: y.id,
            total: {
              key: formatted,
              data: data[formatted],
            },
          };
        }, this);
      },

      _determineColumnTotalRow: function (columns, middleRows, data) {
        var columnData = columns.map(function (z) {
          var formatted = this._formatDisaggregationIds([z.id]);

          return {
            key: formatted,
            data: data[formatted],
          };
        }, this);

        return {
          title: 'total',
          data: columnData,
          total: {
            key: '', // unused
            data: data['()'],
          },
        };
      },

      _determineBottomRows: function (middleRows, columns, data) {
        return this._determineRows(middleRows, columns, data);
      },
    });
  </script>
</dom-module>
