<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/promise-polyfill/promise-polyfill-lite.html">
<link rel="import" href="../../bower_components/moment-element/moment-import.html">

<link rel="import" href="../polyfills/es6-shim.html">
<link rel="import" href="../settings.html">

<script>
  (function () {
    'use strict';

    var pdListStatuses = {
      Signed: 'signed',
      Active: 'active',
      Suspended: 'suspended',
      Ended: 'ended',
      Closed: 'closed',
      Terminated: 'terminated',
      All: 'all',
    };

    App.Behaviors = App.Behaviors || {};

    App.Behaviors.UtilsBehavior = {
      _equals: function (a, b) {
        return a === b;
      },

      _forEach: function (selector, fn) {
        [].forEach.call(
          Polymer.dom(this.root).querySelectorAll(selector),
          fn,
          this
        );
      },

      _toLowerCaseLocalized: function (text, localize) {
        return localize(text).toLowerCase();
      },

      _localizeLowerCased: function (text, localize) {
        return localize(text.split(' ').join('_').toLowerCase());
      },

      _singularLocalized: function (text, localize) {
        return localize(text).substring(0, text.length - 1);
      },

      _withDefault: function (value, defaultValue, localize) {
        if (typeof defaultValue === 'undefined') {
          defaultValue = '...';
        }

        if (pdListStatuses[value] !== undefined) {
          return localize(pdListStatuses[value]);
        }

        return value == null /* undefinded & null */ ? // jshint ignore:line
            defaultValue : value;
      },

      _withDefaultFrom: function (obj, key, defaultValue) {
        if (typeof defaultValue === 'undefined') {
          defaultValue = '...';
        }

        return obj[key] || defaultValue;
      },

      _debug: function (val) {
        return JSON.stringify(val, null, 2);
      },

      _log: function (val) {
        console.log('_log', val);
      },

      _toNumber: function (val) {
        return Number(val);
      },

      _capitalizeFirstLetter: function (text, localize) {
        if (localize !== undefined) {
          return localize(text);
        }

        if (text) {
          return text[0].toUpperCase() + text.substring(1);
        }
      },

      _notFound: function () {
        window.location.href = '/not-found';
      },

      _clone: function _clone(val) {
        var typeStr = Object.prototype.toString.call(val);

        switch (typeStr) {
          case '[object Array]':
            return val.map(_clone);

          case '[object Object]':
            return Object.keys(val).reduce(function (prev, curr) {
              prev[curr] = _clone(val[curr]);

              return prev;
            }, {});

          default:
            return val;
        }
      },

      _deferred: function () {
        var defer = {};

        defer.promise = new Promise(function (resolve, reject) {
          defer.resolve = resolve;
          defer.reject = reject;
        });

        return defer;
      },

      _toPercentage: function (value) {
        return value == null /* undefinded & null */ ? // jshint ignore:line
            value : Math.floor(value * 100) + '%';
      },

      _toPercentageRounded: function (value) {
        return value == null /* undefinded & null */ ? // jshint ignore:line
            value : Math.floor(value * 100) / 100 + '%';
      },

      _formatIndicatorValue: function(indicatorType, value, percentize) {
        if (value == null /* undefinded & null */) { // jshint ignore:line
          return value;
        }

        var _value = value.toFixed(2);

        switch (indicatorType) {
          case 'percentage':
            if (!percentize) {
              return this._toPercentage(value);
            }
            return percentize === 1 ? Math.floor(_value) + '%' : _value + '%';
          case 'ratio':
            return _value + ':1';
          default:
            return _value;
        }
      },

      _displayClusterHeader: function (subpage, needsHeaderList) {
        if (needsHeaderList.indexOf(subpage) >= 0) {
          return true;
        }
        return false;
      },

      _commaSeparated: function (items) {
        if (!items) {
          return '';
        }
        return items.join(', ');
      },

      _commaSeparatedDictValues: function (items, key) {
        var newList = (items || []).map(function(item) {
          return item[key];
        });

        return this._commaSeparated(newList);
      },

       _commaSeparatedValues: function (list) {
        return (list || []).join(', ');
      },

      _formatAddress: function (street, city, zip) {
        if (!(street || city || zip)) {
          return undefined;
        } else if (!street) {
          return city + ' ' + zip;
        } else {
          return street + ',' + city + ' ' + zip;
        }
      },

      _fieldsAreValid: function() {
        var valid;
        var fields = [].slice.call(
          Polymer.dom(this.root).querySelectorAll('.validate')
        );

        fields.forEach(function (field) {
          field.validate();
        });

        valid = fields.every(function (field) {
          return !field.invalid;
        });

        return valid;
      },

      _dateRangeValid: function (start, end) {
        var startField = this.shadowRoot.querySelector(start);
        var endField = this.shadowRoot.querySelector(end);
        var startValue = startField.value;
        var endValue = endField.value;

        if (!Date.parse(startValue) || !Date.parse(endValue)) {
          if (startField.required) {
            startField.invalid = true;
          }

          if (endField.required) {
            endField.invalid = true;
          }

          return false;
        }

        if (new Date(startField.value) >= new Date(endField.value)) {
          startField.invalid = true;
          endField.invalid = true;

          return false;
        }

        startField.invalid = false;
        endField.invalid = false;

        return true;
      },

      _noop: function () {},

      _withDefaultParams: function (queryParams) {
        return Object.assign({}, queryParams, {
          page: 1,
          page_size: 10,
        });
      },

      _appendQuery: function (url) {
        return url + '?' + buildQuery([].slice.call(arguments, 1));
      },

      _cloneNode: function (node) {
        var newNode = node.cloneNode(true);

        for (var prop in node.properties) {
          try {
            newNode[prop] = node[prop];
          } catch (err) {}
        }

        return newNode;
      },

      _identity: function (arg) {
        return arg;
      },

      _truncate: function (str, len) {
        return str.slice(0, len) + (str.length > len ? 'â€¦' : '');
      },

      _cancelDebouncers: function (debouncers) {
        debouncers.forEach(function (debouncer) {
          if (this.isDebouncerActive(debouncer)) {
            this.cancelDebouncer(debouncer);
          }
        }, this);
      },

      _prop: function (obj, key) {
        return obj[key];
      },

      _omit: function (src, keys) {
        return Object.keys(src)
            .filter(function (key) {
              return keys.indexOf(key) === -1;
            })
            .reduce(function (acc, key) {
              acc[key] = src[key];

              return acc;
            }, {});
      },

      _normalizeDate: function (date) {
        return moment(date, App.Settings.dateFormat).startOf('day').toDate();
      },

      _getValidateTarget: function (e) {
        var target = Polymer.dom(e).localTarget;
        if (target && target.validate) {
          return target;
        } else {
          return Polymer.dom(e).rootTarget;
        }
      },

    };

    function buildQuery(chunks) {
      return chunks.map(function (chunk) {
        switch (typeof chunk) {
          case 'string':
            return chunk;

          case 'object':
            return buildQuery(Object.keys(chunk).map(function (key) {
              return [
                encodeURIComponent(key),
                encodeURIComponent(chunk[key]),
              ].join('=');
            }));
        }
      }).join('&');
    }
  }());
</script>
